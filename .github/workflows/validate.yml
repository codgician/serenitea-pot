name: validate

on:
  pull_request:
  push:
    branches: [ main ]
    paths-ignore:
    - '**.md'
    - '.gitignore'
  workflow_dispatch:

jobs:
  validate:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest, macos-latest ]
    steps:
      - name: Checkout new change
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - name: Check flake
        run: nix flake check --all-systems
      - name: Build OS configurations
        if: ${{ false }}
        run: |
          system=$(nix eval --expr "builtins.currentSystem" --impure --raw)
          type=$([[ $system == *-darwin ]] && echo "darwinConfigurations" || echo "nixosConfigurations")
          args=$(nix eval .\#${type} --raw \
            --apply "x: builtins.concatStringsSep \" \" (map (y: \".#${type}.\${y}.config.system.build.toplevel\") \
              (builtins.filter (y: x.\${y}.pkgs.system == ''${system}'') (builtins.attrNames x)))")
          nix build $args
